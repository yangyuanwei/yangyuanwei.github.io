<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="As an iOS developer, nearly every line of code you write is in reaction to some event; a button tap, a received network message, a property change (via Key Value Observing) or a change in user’s locat">
<meta property="og:type" content="article">
<meta property="og:title" content="ReactiveCocoa Tutorial - The Definitive Introduction:Part 1&#x2F;2">
<meta property="og:url" content="http://yoursite.com/2017/09/11/01-ReactiveCocoa-Part1-2/index.html">
<meta property="og:site_name" content="YYW’s Blog">
<meta property="og:description" content="As an iOS developer, nearly every line of code you write is in reaction to some event; a button tap, a received network message, a property change (via Key Value Observing) or a change in user’s locat">
<meta property="og:locale">
<meta property="article:published_time" content="2017-09-11T14:36:18.000Z">
<meta property="article:modified_time" content="2021-07-12T08:37:54.662Z">
<meta property="article:author" content="yangyuanwei">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Pisces',
    version: '5.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/09/11/01-ReactiveCocoa-Part1-2/"/>





  <title>ReactiveCocoa Tutorial - The Definitive Introduction:Part 1/2 | YYW’s Blog</title>
  








<meta name="generator" content="Hexo 5.4.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">YYW’s Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home  //首页"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive   //归档"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th    //分类"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags         //标签"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user         //关于"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/11/01-ReactiveCocoa-Part1-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YYW’s Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">ReactiveCocoa Tutorial - The Definitive Introduction:Part 1/2</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-11T22:36:18+08:00">
                2017-09-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>As an iOS developer, nearly every line of code you write is in reaction to some event; a button tap, a received network message, a property change (via Key Value Observing) or a change in user’s location via CoreLocation are all good examples. However, these events are all encoded in different ways; as actions, delegates, KVO, callbacks and others. ReactiveCocoa defines a standard interface for events, so they can be more easily chained, filtered and composed using a basic set of tools.</p>
<span id="more"></span>
<p>Sound confusing? Intriguing? … Mind blowing? Then read on :]</p>
<p>ReactiveCocoa combines a couple of programming styles:</p>
<p>Functional Programming which makes use of higher order functions, i.e. functions which take other functions as their arguments<br>Reactive Programming which focuses of data-flows and change propagation<br>For this reason, you might hear ReactiveCocoa described as a Functional Reactive Programming (or FRP) framework.</p>
<p>Rest assured, that is as academic as this tutorial is going to get! Programming paradigms are a fascinating subject, but the rest of this ReactiveCocoa tutorials focuses solely on the practical value, with work-through examples instead of academic theories.</p>
<p>The Reactive Playground</p>
<p>Throughout this ReactiveCocoa tutorial, you’ll be introducing reactive programming to a very simple example application, the ReactivePlayground. Download the starter project, then build and run to verify you have everything set up correctly.</p>
<p>ReactivePlayground is a very simple app that presents a sign-in screen to the user. Supply the correct credentials, which are, somewhat imaginatively, user for the username, and password for the password, and you’ll be greeted by a picture of a lovely little kitten.</p>
<p>Awww! How cute!</p>
<p>Right now it’s a good point to spend a little time looking through the code of this starter project. It is quite simple, so it shouldn’t take long.</p>
<p>Open RWViewController.m and take a look around. How quickly can you identify the condition that results in the enabling of the Sign In button? What are the rules for showing / hiding the signInFailure label? In this relatively simple example, it might take only a minute or two to answer these questions. For a more complex example, you should be able to see how this same type of analysis might take quite a bit longer.</p>
<p>With the use of ReactiveCocoa, the underlying intent of the application will become a lot clearer. It’s time to get started!</p>
<p>Adding the ReactiveCocoa Framework</p>
<p>The easiest way to add the ReactiveCocoa framework to your project is via CocoaPods. If you’ve never used CocoaPods before it might make sense to follow the Introduction To CocoaPods tutorial on this site, or at the very least run through the initial steps of that tutorial so you can install the prerequisites.</p>
<p>Note: If for some reason you don’t want to use CocoaPods you can still use ReactiveCocoa, just follow the Importing ReactiveCocoa steps in the documentation on GitHub.</p>
<p>If you still have the ReactivePlayground project open in Xcode, then close it now. CocoaPods will create an Xcode workspace, which you’ll want to use instead of the original project file.</p>
<p>Open Terminal. Navigate to the folder where your project is located and type the following:</p>
<p>touch Podfile<br>open -e Podfile</p>
<p>This creates an empty file called Podfile and opens it with TextEdit. Copy and paste the following lines into the TextEdit window:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">platform :ios, <span class="string">&#x27;7.0&#x27;</span></span><br><span class="line"></span><br><span class="line">pod <span class="string">&#x27;ReactiveCocoa&#x27;</span>, <span class="string">&#x27;2.1.8&#x27;</span></span><br></pre></td></tr></table></figure>

<p>This sets the platform to iOS, the minimum SDK version to 7.0, and adds the ReactiveCocoa framework as a dependency.</p>
<p>Once you’ve saved this file, go back to the Terminal window and issue the following command:</p>
<p>pod install</p>
<p>You should see an output similar to the following:</p>
<p>Analyzing dependencies<br>Downloading dependencies<br>Installing ReactiveCocoa (2.1.8)<br>Generating Pods project<br>Integrating client project</p>
<p>[!] From now on use <code>RWReactivePlayground.xcworkspace</code>.</p>
<p>This indicates that the ReactiveCocoa framework has been downloaded, and CocoaPods has created an Xcode workspace to integrate the framework into your existing application.</p>
<p>Open up the newly generated workspace, RWReactivePlayground.xcworkspace, and look at the structure CocoaPods created inside the Project Navigator:</p>
<p>You should see that CocoaPods created a new workspace and added the original project, RWReactivePlayground, together with a Pods project that includes ReactiveCocoa. CocoaPods really does make managing dependencies a breeze!</p>
<p>You’ll notice this project’s name is ReactivePlayground, so that must mean it’s time to play …</p>
<p>Time To Play</p>
<p>As mentioned in the introduction, ReactiveCocoa provides a standard interface for handling the disparate stream of events that occur within your application. In ReactiveCocoa terminology these are called signals, and are represented by the RACSignal class.</p>
<p>Open the initial view controller for this app, RWViewController.m, and import the ReactiveCocoa header by adding the following to the top of the file:</p>
<p>#import &lt;ReactiveCocoa/ReactiveCocoa.h&gt;</p>
<p>You aren’t going to replace any of the existing code just yet, for now you’re just going to play around a bit. Add the following code to the end of the viewDidLoad method:</p>
<p>[self.usernameTextField.rac_textSignal subscribeNext:^(id x) {<br>NSLog(@”%@”, x);<br>}];</p>
<p>Build and run the application and type some text into the username text field. Keep an eye on the console and look for an output similar to the following:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">2013-12-24 14:48:50.359 RWReactivePlayground[9193:a0b] i</span><br><span class="line">2013-12-24 14:48:50.436 RWReactivePlayground[9193:a0b] is</span><br><span class="line">2013-12-24 14:48:50.541 RWReactivePlayground[9193:a0b] is </span><br><span class="line">2013-12-24 14:48:50.695 RWReactivePlayground[9193:a0b] is t</span><br><span class="line">2013-12-24 14:48:50.831 RWReactivePlayground[9193:a0b] is th</span><br><span class="line">2013-12-24 14:48:50.878 RWReactivePlayground[9193:a0b] is thi</span><br><span class="line">2013-12-24 14:48:50.901 RWReactivePlayground[9193:a0b] is this</span><br><span class="line">2013-12-24 14:48:51.009 RWReactivePlayground[9193:a0b] is this </span><br><span class="line">2013-12-24 14:48:51.142 RWReactivePlayground[9193:a0b] is this m</span><br><span class="line">2013-12-24 14:48:51.236 RWReactivePlayground[9193:a0b] is this ma</span><br><span class="line">2013-12-24 14:48:51.335 RWReactivePlayground[9193:a0b] is this mag</span><br><span class="line">2013-12-24 14:48:51.439 RWReactivePlayground[9193:a0b] is this magi</span><br><span class="line">2013-12-24 14:48:51.535 RWReactivePlayground[9193:a0b] is this magic</span><br><span class="line">2013-12-24 14:48:51.774 RWReactivePlayground[9193:a0b] is this magic?```</span><br><span class="line"></span><br><span class="line">You can see that each time you change the text within the text field, the code within the block executes. No target-action, no delegates — just signals and blocks. That’s pretty exciting!</span><br><span class="line"></span><br><span class="line">ReactiveCocoa signals (represented by RACSignal) send a stream of events to their subscribers. There are three types of events to know: next, error and completed. A signal may send any number of next events before it terminates after an error, or it completes. In this part of the tutorial you’ll focus on the next event. Be sure to <span class="built_in">read</span> part two when it’s available to learn about error and completed events.</span><br><span class="line"></span><br><span class="line">RACSignal has a number of methods you can use to subscribe to these different event types. Each method takes one or more blocks, with the logic <span class="keyword">in</span> your block executing when an event occurs. In this <span class="keyword">case</span>, you can see that the subscribeNext: method was used to supply a block that executes on each next event.</span><br><span class="line"></span><br><span class="line">The ReactiveCocoa framework uses categories to add signals to many of the standard UIKit controls so you can add subscriptions to their events, <span class="built_in">which</span> is <span class="built_in">where</span> the rac_textSignal property on the text field came from.</span><br><span class="line"></span><br><span class="line">But enough with the theory, it’s time to start making ReactiveCocoa <span class="keyword">do</span> some work <span class="keyword">for</span> you!</span><br><span class="line"></span><br><span class="line">ReactiveCocoa has a large range of operators you can use to manipulate streams of events. For example, assume you’re only interested <span class="keyword">in</span> a username <span class="keyword">if</span> it’s more than three characters long. You can achieve this by using the filter operator. Update the code you added previously <span class="keyword">in</span> viewDidLoad to the following:</span><br><span class="line"></span><br><span class="line">           ``` bash</span><br><span class="line">            [[self.usernameTextField.rac_textSignal</span><br><span class="line">            filter:^BOOL(id value) &#123;</span><br><span class="line">            NSString *text = value;</span><br><span class="line">            <span class="built_in">return</span> text.length &gt; 3;</span><br><span class="line">            &#125;]</span><br><span class="line">            subscribeNext:^(id x) &#123;</span><br><span class="line">            NSLog(@<span class="string">&quot;%@&quot;</span>, x);</span><br><span class="line">            &#125;];</span><br></pre></td></tr></table></figure>

<p>If you build and run, then type some text into the text field, you should find that it only starts logging when the text field length is greater than three characters:</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2013</span>-<span class="number">12</span>-<span class="number">26</span> <span class="number">08</span>:<span class="number">17</span>:<span class="number">51.335</span> RWReactivePlayground[<span class="number">9654</span>:a0b] <span class="keyword">is</span> t</span><br><span class="line"><span class="number">2013</span>-<span class="number">12</span>-<span class="number">26</span> <span class="number">08</span>:<span class="number">17</span>:<span class="number">51.478</span> RWReactivePlayground[<span class="number">9654</span>:a0b] <span class="keyword">is</span> th</span><br><span class="line"><span class="number">2013</span>-<span class="number">12</span>-<span class="number">26</span> <span class="number">08</span>:<span class="number">17</span>:<span class="number">51.526</span> RWReactivePlayground[<span class="number">9654</span>:a0b] <span class="keyword">is</span> thi</span><br><span class="line"><span class="number">2013</span>-<span class="number">12</span>-<span class="number">26</span> <span class="number">08</span>:<span class="number">17</span>:<span class="number">51.548</span> RWReactivePlayground[<span class="number">9654</span>:a0b] <span class="keyword">is</span> this</span><br><span class="line"><span class="number">2013</span>-<span class="number">12</span>-<span class="number">26</span> <span class="number">08</span>:<span class="number">17</span>:<span class="number">51.676</span> RWReactivePlayground[<span class="number">9654</span>:a0b] <span class="keyword">is</span> this </span><br><span class="line"><span class="number">2013</span>-<span class="number">12</span>-<span class="number">26</span> <span class="number">08</span>:<span class="number">17</span>:<span class="number">51.798</span> RWReactivePlayground[<span class="number">9654</span>:a0b] <span class="keyword">is</span> this m</span><br><span class="line"><span class="number">2013</span>-<span class="number">12</span>-<span class="number">26</span> <span class="number">08</span>:<span class="number">17</span>:<span class="number">51.926</span> RWReactivePlayground[<span class="number">9654</span>:a0b] <span class="keyword">is</span> this ma</span><br><span class="line"><span class="number">2013</span>-<span class="number">12</span>-<span class="number">26</span> <span class="number">08</span>:<span class="number">17</span>:<span class="number">51.987</span> RWReactivePlayground[<span class="number">9654</span>:a0b] <span class="keyword">is</span> this mag</span><br><span class="line"><span class="number">2013</span>-<span class="number">12</span>-<span class="number">26</span> <span class="number">08</span>:<span class="number">17</span>:<span class="number">52.141</span> RWReactivePlayground[<span class="number">9654</span>:a0b] <span class="keyword">is</span> this magi</span><br><span class="line"><span class="number">2013</span>-<span class="number">12</span>-<span class="number">26</span> <span class="number">08</span>:<span class="number">17</span>:<span class="number">52.229</span> RWReactivePlayground[<span class="number">9654</span>:a0b] <span class="keyword">is</span> this magic</span><br><span class="line"><span class="number">2013</span>-<span class="number">12</span>-<span class="number">26</span> <span class="number">08</span>:<span class="number">17</span>:<span class="number">52.486</span> RWReactivePlayground[<span class="number">9654</span>:a0b] <span class="keyword">is</span> this magic?```</span><br><span class="line"></span><br><span class="line">What you’ve created here <span class="keyword">is</span> a very simple pipeline. It <span class="keyword">is</span> the very essence <span class="keyword">of</span> Reactive Programming, <span class="keyword">where</span> you express your application’s functionality <span class="keyword">in</span> terms <span class="keyword">of</span> data flows.</span><br><span class="line"></span><br><span class="line">It can help <span class="keyword">to</span> picture these flows graphically:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">In</span> the above diagram you can see that the rac_textSignal <span class="keyword">is</span> the initial source <span class="keyword">of</span> events. The data flows through a filter that only allows events <span class="keyword">to</span> pass <span class="keyword">if</span> they contain a string <span class="keyword">with</span> a length that <span class="keyword">is</span> greater than three. The <span class="keyword">final</span> <span class="keyword">step</span> <span class="keyword">in</span> the pipeline <span class="keyword">is</span> subscribeNext: <span class="keyword">where</span> your <span class="keyword">block</span> logs the <span class="keyword">event</span> value.</span><br><span class="line"></span><br><span class="line">At this point it’s worth noting that the output <span class="keyword">of</span> the filter operation <span class="keyword">is</span> also an RACSignal. You could arrange the code <span class="keyword">as</span> follows <span class="keyword">to</span> show the discrete pipeline steps:</span><br><span class="line"></span><br><span class="line">    ```bash</span><br><span class="line">    RACSignal *usernameSourceSignal = </span><br><span class="line">    <span class="keyword">self</span>.usernameTextField.rac_textSignal;</span><br><span class="line"></span><br><span class="line">    RACSignal *filteredUsername = [usernameSourceSignal  </span><br><span class="line">    filter:^BOOL(id value) <span class="comment">&#123;</span></span><br><span class="line"><span class="comment">    NSString *text = value;</span></span><br><span class="line"><span class="comment">    return text.length &gt; 3;</span></span><br><span class="line"><span class="comment">    &#125;</span>];</span><br><span class="line"></span><br><span class="line">    [filteredUsername subscribeNext:^(id x) <span class="comment">&#123;</span></span><br><span class="line"><span class="comment">    NSLog(@&quot;%@&quot;, x);</span></span><br><span class="line"><span class="comment">    &#125;</span>];```</span><br><span class="line"></span><br><span class="line">Because <span class="keyword">each</span> operation <span class="keyword">on</span> an RACSignal also returns an RACSignal it’s termed a fluent <span class="keyword">interface</span>. This feature allows you <span class="keyword">to</span> construct pipelines without the need <span class="keyword">to</span> <span class="keyword">reference</span> <span class="keyword">each</span> <span class="keyword">step</span> <span class="keyword">using</span> a local variable.</span><br><span class="line"></span><br><span class="line">Note: ReactiveCocoa makes heavy use <span class="keyword">of</span> blocks. <span class="keyword">If</span> you’re <span class="keyword">new</span> <span class="keyword">to</span> blocks, you might want <span class="keyword">to</span> <span class="keyword">read</span> Apple’s Blocks Programming Topics. <span class="keyword">And</span> <span class="keyword">if</span>, like me, you’re familiar <span class="keyword">with</span> blocks, but find the syntax a little confusing <span class="keyword">and</span> hard <span class="keyword">to</span> remember, you might find the amusingly titled f*****gblocksyntax.com quite useful! (We censored the word <span class="keyword">to</span> protect the innocent, but the link <span class="keyword">is</span> fully functional.)</span><br><span class="line">A Little Cast</span><br><span class="line"></span><br><span class="line"><span class="keyword">If</span> you updated your code <span class="keyword">to</span> split it <span class="keyword">into</span> the various RACSignal components, now <span class="keyword">is</span> the time <span class="keyword">to</span> revert it back <span class="keyword">to</span> the fluent syntax:</span><br><span class="line"></span><br><span class="line">    ```bash</span><br><span class="line">    [[<span class="keyword">self</span>.usernameTextField.rac_textSignal</span><br><span class="line">    filter:^BOOL(id value) <span class="comment">&#123;</span></span><br><span class="line"><span class="comment">    NSString *text = value; // implicit cast</span></span><br><span class="line"><span class="comment">    return text.length &gt; 3;</span></span><br><span class="line"><span class="comment">    &#125;</span>]</span><br><span class="line">    subscribeNext:^(id x) <span class="comment">&#123;</span></span><br><span class="line"><span class="comment">    NSLog(@&quot;%@&quot;, x);</span></span><br><span class="line"><span class="comment">    &#125;</span>];```</span><br><span class="line"></span><br><span class="line">The implicit cast <span class="keyword">from</span> id <span class="keyword">to</span> NSString, at the indicated location <span class="keyword">in</span> the code above, <span class="keyword">is</span> less than elegant. Fortunately, since the value passed <span class="keyword">to</span> this <span class="keyword">block</span> <span class="keyword">is</span> always going <span class="keyword">to</span> be an NSString, you can change the parameter <span class="keyword">type</span> itself. Update your code <span class="keyword">as</span> follows:</span><br><span class="line"></span><br><span class="line">   ```bash</span><br><span class="line">    [[<span class="keyword">self</span>.usernameTextField.rac_textSignal</span><br><span class="line">    filter:^BOOL(NSString *text) <span class="comment">&#123;</span></span><br><span class="line"><span class="comment">    return text.length &gt; 3;</span></span><br><span class="line"><span class="comment">    &#125;</span>]</span><br><span class="line">    subscribeNext:^(id x) <span class="comment">&#123;</span></span><br><span class="line"><span class="comment">    NSLog(@&quot;%@&quot;, x);</span></span><br><span class="line"><span class="comment">    &#125;</span>];```</span><br><span class="line"></span><br><span class="line">Build <span class="keyword">and</span> run <span class="keyword">to</span> confirm this works just <span class="keyword">as</span> it did previously.</span><br><span class="line"></span><br><span class="line">What’s An <span class="keyword">Event</span>?</span><br><span class="line"></span><br><span class="line">So far this tutorial <span class="keyword">has</span> described the different <span class="keyword">event</span> types, but hasn’t detailed the structure <span class="keyword">of</span> these events. What’s interesting <span class="keyword">is</span> that an <span class="keyword">event</span> can contain absolutely anything!</span><br><span class="line"></span><br><span class="line"><span class="keyword">As</span> an illustration <span class="keyword">of</span> this point, you’re going <span class="keyword">to</span> <span class="keyword">add</span> another operation <span class="keyword">to</span> the pipeline. Update the code you added <span class="keyword">to</span> viewDidLoad <span class="keyword">as</span> follows:</span><br><span class="line"></span><br><span class="line">        ```bash</span><br><span class="line">        [[[<span class="keyword">self</span>.usernameTextField.rac_textSignal</span><br><span class="line">        map:^id(NSString *text) <span class="comment">&#123;</span></span><br><span class="line"><span class="comment">        return @(text.length);</span></span><br><span class="line"><span class="comment">        &#125;</span>]</span><br><span class="line">        filter:^BOOL(NSNumber *length) <span class="comment">&#123;</span></span><br><span class="line"><span class="comment">        return [length integerValue] &gt; 3;</span></span><br><span class="line"><span class="comment">        &#125;</span>]</span><br><span class="line">        subscribeNext:^(id x) <span class="comment">&#123;</span></span><br><span class="line"><span class="comment">        NSLog(@&quot;%@&quot;, x);</span></span><br><span class="line"><span class="comment">        &#125;</span>];```</span><br><span class="line"></span><br><span class="line"><span class="keyword">If</span> you build <span class="keyword">and</span> run you’ll find the app now logs the length <span class="keyword">of</span> the text instead <span class="keyword">of</span> the contents:</span><br><span class="line"></span><br><span class="line">    ```bash</span><br><span class="line">        <span class="number">2013</span>-<span class="number">12</span>-<span class="number">26</span> <span class="number">12</span>:<span class="number">06</span>:<span class="number">54.566</span> RWReactivePlayground[<span class="number">10079</span>:a0b] <span class="number">4</span></span><br><span class="line">        <span class="number">2013</span>-<span class="number">12</span>-<span class="number">26</span> <span class="number">12</span>:<span class="number">06</span>:<span class="number">54.725</span> RWReactivePlayground[<span class="number">10079</span>:a0b] <span class="number">5</span></span><br><span class="line">        <span class="number">2013</span>-<span class="number">12</span>-<span class="number">26</span> <span class="number">12</span>:<span class="number">06</span>:<span class="number">54.853</span> RWReactivePlayground[<span class="number">10079</span>:a0b] <span class="number">6</span></span><br><span class="line">        <span class="number">2013</span>-<span class="number">12</span>-<span class="number">26</span> <span class="number">12</span>:<span class="number">06</span>:<span class="number">55.061</span> RWReactivePlayground[<span class="number">10079</span>:a0b] <span class="number">7</span></span><br><span class="line">        <span class="number">2013</span>-<span class="number">12</span>-<span class="number">26</span> <span class="number">12</span>:<span class="number">06</span>:<span class="number">55.197</span> RWReactivePlayground[<span class="number">10079</span>:a0b] <span class="number">8</span></span><br><span class="line">        <span class="number">2013</span>-<span class="number">12</span>-<span class="number">26</span> <span class="number">12</span>:<span class="number">06</span>:<span class="number">55.300</span> RWReactivePlayground[<span class="number">10079</span>:a0b] <span class="number">9</span></span><br><span class="line">        <span class="number">2013</span>-<span class="number">12</span>-<span class="number">26</span> <span class="number">12</span>:<span class="number">06</span>:<span class="number">55.462</span> RWReactivePlayground[<span class="number">10079</span>:a0b] <span class="number">10</span></span><br><span class="line">        <span class="number">2013</span>-<span class="number">12</span>-<span class="number">26</span> <span class="number">12</span>:<span class="number">06</span>:<span class="number">55.558</span> RWReactivePlayground[<span class="number">10079</span>:a0b] <span class="number">11</span></span><br><span class="line">        <span class="number">2013</span>-<span class="number">12</span>-<span class="number">26</span> <span class="number">12</span>:<span class="number">06</span>:<span class="number">55.646</span> RWReactivePlayground[<span class="number">10079</span>:a0b] <span class="number">12</span>```</span><br><span class="line"></span><br><span class="line">The newly added map operation transforms the <span class="keyword">event</span> data <span class="keyword">using</span> the supplied <span class="keyword">block</span>. <span class="keyword">For</span> <span class="keyword">each</span> next <span class="keyword">event</span> it receives, it runs the given <span class="keyword">block</span> <span class="keyword">and</span> emits the return value <span class="keyword">as</span> a next <span class="keyword">event</span>. <span class="keyword">In</span> the code above, the map takes the NSString input <span class="keyword">and</span> takes its length, which results <span class="keyword">in</span> an NSNumber being returned.</span><br><span class="line"></span><br><span class="line"><span class="keyword">For</span> a stunning graphic depiction <span class="keyword">of</span> how this works, <span class="keyword">take</span> a look at this image:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">As</span> you can see, all <span class="keyword">of</span> the steps that follow the map operation now receive NSNumber instances. You can use the map operation <span class="keyword">to</span> transform the received data <span class="keyword">into</span> anything you like, <span class="keyword">as</span> long <span class="keyword">as</span> it’s an object.</span><br><span class="line"></span><br><span class="line">Note: <span class="keyword">In</span> the above example the text.length <span class="keyword">property</span> returns an NSUInteger, which <span class="keyword">is</span> a primitive <span class="keyword">type</span>. <span class="keyword">In</span> <span class="keyword">order</span> <span class="keyword">to</span> use it <span class="keyword">as</span> the contents <span class="keyword">of</span> an <span class="keyword">event</span>, it must be boxed. Fortunately the Objective-C literal syntax provides <span class="keyword">and</span> option <span class="keyword">to</span> <span class="keyword">do</span> this <span class="keyword">in</span> a rather concise manner – @(text.length).</span><br><span class="line">That’s enough playing! It’s time <span class="keyword">to</span> update the ReactivePlayground app <span class="keyword">to</span> use the concepts you’ve learned so far. You may <span class="keyword">remove</span> all <span class="keyword">of</span> the code you’ve added since you started this tutorial.</span><br><span class="line"></span><br><span class="line">Creating Valid State Signals</span><br><span class="line"></span><br><span class="line">The first thing you need <span class="keyword">to</span> <span class="keyword">do</span> <span class="keyword">is</span> <span class="keyword">create</span> a couple <span class="keyword">of</span> signals that indicate whether the username <span class="keyword">and</span> password text fields are valid. <span class="keyword">Add</span> the following <span class="keyword">to</span> the <span class="keyword">end</span> <span class="keyword">of</span> viewDidLoad <span class="keyword">in</span> RWViewController.m:</span><br><span class="line"></span><br><span class="line">    ``` bash</span><br><span class="line">        RACSignal *validUsernameSignal =</span><br><span class="line">        [<span class="keyword">self</span>.usernameTextField.rac_textSignal</span><br><span class="line">        map:^id(NSString *text) <span class="comment">&#123;</span></span><br><span class="line"><span class="comment">        return @([self isValidUsername:text]);</span></span><br><span class="line"><span class="comment">        &#125;</span>];</span><br><span class="line"></span><br><span class="line">        RACSignal *validPasswordSignal =</span><br><span class="line">        [<span class="keyword">self</span>.passwordTextField.rac_textSignal</span><br><span class="line">        map:^id(NSString *text) <span class="comment">&#123;</span></span><br><span class="line"><span class="comment">        return @([self isValidPassword:text]);</span></span><br><span class="line"><span class="comment">        &#125;</span>];```</span><br><span class="line"></span><br><span class="line"><span class="keyword">As</span> you can see, the above code applies a map transform <span class="keyword">to</span> the rac_textSignal <span class="keyword">from</span> <span class="keyword">each</span> text field. The output <span class="keyword">is</span> a boolean value boxed <span class="keyword">as</span> a NSNumber.</span><br><span class="line"></span><br><span class="line">The next <span class="keyword">step</span> <span class="keyword">is</span> <span class="keyword">to</span> transform these signals so that they provide a nice background color <span class="keyword">to</span> the text fields. Basically, you subscribe <span class="keyword">to</span> this signal <span class="keyword">and</span> use the <span class="keyword">result</span> <span class="keyword">to</span> update the text field background color. One viable option <span class="keyword">is</span> <span class="keyword">as</span> follows:</span><br><span class="line"></span><br><span class="line">    ```bash</span><br><span class="line">        [[validPasswordSignal</span><br><span class="line">        map:^id(NSNumber *passwordValid) <span class="comment">&#123;</span></span><br><span class="line"><span class="comment">        return [passwordValid boolValue] ? [UIColor clearColor] : [UIColor yellowColor];</span></span><br><span class="line"><span class="comment">        &#125;</span>]</span><br><span class="line">        subscribeNext:^(UIColor *color) <span class="comment">&#123;</span></span><br><span class="line"><span class="comment">        self.passwordTextField.backgroundColor = color;</span></span><br><span class="line"><span class="comment">        &#125;</span>]; ```</span><br><span class="line"></span><br><span class="line">(Please don’t <span class="keyword">add</span> this code, there’s a much more elegant solution coming!)</span><br><span class="line"></span><br><span class="line">Conceptually you’re assigning the output <span class="keyword">of</span> this signal <span class="keyword">to</span> the backgroundColor <span class="keyword">property</span> <span class="keyword">of</span> the text field. However, the code above <span class="keyword">is</span> a poor expression <span class="keyword">of</span> this; it’s all backwards!</span><br><span class="line"></span><br><span class="line">Fortunately, ReactiveCocoa <span class="keyword">has</span> a macro that allows you <span class="keyword">to</span> express this <span class="keyword">with</span> grace <span class="keyword">and</span> elegance. <span class="keyword">Add</span> the following code directly beneath the two signals you added <span class="keyword">to</span> viewDidLoad:</span><br><span class="line">```bash</span><br><span class="line">        RAC(<span class="keyword">self</span>.passwordTextField, backgroundColor) =</span><br><span class="line">        [validPasswordSignal</span><br><span class="line">        map:^id(NSNumber *passwordValid) <span class="comment">&#123;</span></span><br><span class="line"><span class="comment">        return [passwordValid boolValue] ? [UIColor clearColor] : [UIColor yellowColor];</span></span><br><span class="line"><span class="comment">        &#125;</span>];</span><br><span class="line"></span><br><span class="line">        RAC(<span class="keyword">self</span>.usernameTextField, backgroundColor) =</span><br><span class="line">        [validUsernameSignal</span><br><span class="line">        map:^id(NSNumber *passwordValid) <span class="comment">&#123;</span></span><br><span class="line"><span class="comment">        return [passwordValid boolValue] ? [UIColor clearColor] : [UIColor yellowColor];</span></span><br><span class="line"><span class="comment">        &#125;</span>];</span><br></pre></td></tr></table></figure>

<p>The RAC macro allows you to assign the output of a signal to the property of an object. It takes two arguments, the first is the object that contains the property to set and the second is the property name. Each time the signal emits a next event, the value that passes is assigned to the given property.</p>
<p>This is a very elegant solution, don’t you think?</p>
<p>One last thing before you build and run. Locate the updateUIState method and remove the first two lines:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">self.usernameTextField.backgroundColor = self.usernameIsValid ? [UIColor clearColor] : [UIColor yellowColor];</span><br><span class="line">self.passwordTextField.backgroundColor = self.passwordIsValid ? [UIColor clearColor] : [UIColor yellowColor];</span><br></pre></td></tr></table></figure>

<p>That will clean up the non-reactive code.</p>
<p>Build and run the application. You should find that the text fields look highlighted when invalid, and clear when valid.</p>
<p>Visuals are nice, so here is a way to visualize the current logic. Here you can see two simple pipelines that take the text signals, map them to validity-indicating booleans, and then follow with a second mapping to a UIColorwhich is the part that binds to the background color of the text field.</p>
<p>Are you wondering why you created separate validPasswordSignal and validUsernameSignal signals, as opposed to a single fluent pipeline for each text field? Patience dear reader, the method behind this madness will become clear shortly!</p>
<p>Combining signals</p>
<p>In the current app, the Sign In button only works when both the username and password text fields have valid input. It’s time to do this reactive-style!</p>
<p>The current code already has signals that emit a boolean value to indicate if the username and password fields are valid; validUsernameSignal and validPasswordSignal. Your task is to combine these two signals to determine when it is okay to enable the button.</p>
<p>At the end of viewDidLoad add the following:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *signUpActiveSignal =</span><br><span class="line">[RACSignal combineLatest:@[validUsernameSignal, validPasswordSignal]</span><br><span class="line">reduce:^id(NSNumber *usernameValid, NSNumber *passwordValid) &#123;</span><br><span class="line"><span class="built_in">return</span> @([usernameValid boolValue] &amp;&amp; [passwordValid boolValue]);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<p>The above code uses the combineLatest:reduce: method to combine the latest values emitted by validUsernameSignal and validPasswordSignal into a shiny new signal. Each time either of the two source signals emits a new value, the reduce block executes, and the value it returns is sent as the next value of the combined signal.</p>
<p>Note: The RACSignal combine methods can combine any number of signals, and the arguments of the reduce block correspond to each of the source signals. ReactiveCocoa has a cunning little utility class, RACBlockTrampoline that handles the reduce block’s variable argument list internally. In fact, there are a lot of cunning tricks hidden within the ReactiveCocoa implementation, so it’s well worth pulling back the covers!<br>Now that you have a suitable signal, add the following to the end of viewDidLoad. This will wire it up to the enabled property on the button:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[signUpActiveSignal subscribeNext:^(NSNumber *signupActive) &#123;</span><br><span class="line">self.signInButton.enabled = [signupActive boolValue];</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<p>Before running this code, it’s time to rip out the old implementation. Remove these two properties from the top of the file:</p>
<p>@property (nonatomic) BOOL passwordIsValid;<br>@property (nonatomic) BOOL usernameIsValid;</p>
<p>From near the top of viewDidLoad, remove the following:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// handle text changes <span class="keyword">for</span> both text fields</span><br><span class="line">    [self.usernameTextField addTarget:self</span><br><span class="line">    action:@selector(usernameTextFieldChanged)</span><br><span class="line">    forControlEvents:UIControlEventEditingChanged];</span><br><span class="line">    [self.passwordTextField addTarget:self </span><br><span class="line">    action:@selector(passwordTextFieldChanged)</span><br><span class="line">    forControlEvents:UIControlEventEditingChanged];</span><br></pre></td></tr></table></figure>
<p>Also remove the updateUIState, usernameTextFieldChanged and passwordTextFieldChanged methods. Whew! That’s a lot of non-reactive code you just disposed of! You’ll be thankful you did.</p>
<p>Finally, make sure to remove the call to updateUIState from viewDidLoad as well.</p>
<p>If you build and run, check the Sign In button. It should be enabled because the username and password text fields are valid, as they were before.</p>
<p>An update to the application logic diagram gives the following:</p>
<p>The above illustrates a couple of important concepts that allow you to perform some pretty powerful tasks with ReactiveCocoa;</p>
<p>Splitting – signals can have multiple subscribers and serve as the source for more multiple subsequent pipeline steps. In the above diagram, note that the boolean signals that indicate password and username validity are split and used for a couple of different purposes.<br>Combining – multiple signals may be combined to create new signals. In this case, two boolean signals were combined. However, you can combine signals that emit any value type.<br>The result of these changes is the application no longer has private properties that indicate the current valid state of the two text fields. This is one of the key differences you’ll find when you adopt a reactive style — you don’t need to use instance variables to track transient state.</p>
<p>Reactive Sign-in</p>
<p>The application currently uses the reactive pipelines illustrated above to manage the state of the text fields and button. However, the button press handling still uses actions, so the next step is to replace the remaining application logic in order to make it all reactive!</p>
<p>The Touch Up Inside event on the Sign In button is wired up to the signInButtonTouched method in RWViewController.m via a storyboard action. You’re going to replace this with the reactive equivalent, so you first need to disconnect the current storyboard action.</p>
<p>Open up Main.storyboard, locate the Sign In button, ctrl-click to bring up the outlet / action connections and click the x to remove the connection. If you feel a little lost, the diagram below kindly shows where to find the delete button:</p>
<p>You’ve already seen how the ReactiveCocoa framework adds properties and methods to the standard UIKit controls. So far you’ve used rac_textSignal, which emits events when the text changes. In order to handle events you need to use another of the methods that ReactiveCocoa adds to UIKit, rac_signalForControlEvents.</p>
<p>Returning to RWViewController.m, add the following to the end of viewDidLoad:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[[self.signInButton</span><br><span class="line">rac_signalForControlEvents:UIControlEventTouchUpInside]</span><br><span class="line">subscribeNext:^(id x) &#123;</span><br><span class="line">NSLog(@<span class="string">&quot;button clicked&quot;</span>);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<p>The above code creates a signal from the button’s UIControlEventTouchUpInside event and adds a subscription to make a log entry every time this event occurs.</p>
<p>Build and run to confirm the message actually logs. Bear in mind that the button will enable only when the username and password are valid, so be sure to type some text into both fields before tapping the button!</p>
<p>You should see messages in the Xcode console similar to the following:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2013-12-28 08:05:10.816 RWReactivePlayground[18203:a0b] button clicked</span><br><span class="line">2013-12-28 08:05:11.675 RWReactivePlayground[18203:a0b] button clicked</span><br><span class="line">2013-12-28 08:05:12.605 RWReactivePlayground[18203:a0b] button clicked</span><br><span class="line">2013-12-28 08:05:12.766 RWReactivePlayground[18203:a0b] button clicked</span><br><span class="line">2013-12-28 08:05:12.917 RWReactivePlayground[18203:a0b] button clicked</span><br></pre></td></tr></table></figure>
<p>Now that the button has a signal for the touch event, the next step is to wire this up with the sign-in process itself. This presents something of a problem — but that’s good, you don’t mind a problem, right? Open up RWDummySignInService.h and take a look at the interface:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> (^RWSignInResponse)(<span class="built_in">BOOL</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">RWDummySignInService</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)signInWithUsername:(<span class="built_in">NSString</span> *)username</span><br><span class="line">password:(<span class="built_in">NSString</span> *)password </span><br><span class="line">complete:(RWSignInResponse)completeBlock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>This service takes a username, a password and a completion block as parameters. The given block is run when the sign-in is successful or when it fails. You could use this interface directly within the subscribeNext: block that currently logs the button touch event, but why would you? This is the kind of asynchronous, event-based behavior that ReactiveCocoa eats for breakfast!</p>
<p>Note: A dummy service is being used in this tutorial for simplicity, so that you don’t have any dependencies on external APIs. However, you’ve now run up against a very real problem, how do you use APIs not expressed in terms of signals?<br>Creating Signals</p>
<p>Fortunately, it’s rather easy to adapt existing asynchronous APIs to be expressed as a signal. First, remove the current signInButtonTouched: method from the RWViewController.m. You don’t need this logic as it will be replaced with a reactive equivalent.</p>
<p>Stay in RWViewController.m and add the following method:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-(RACSignal *)signInSignal &#123;</span><br><span class="line"><span class="built_in">return</span> [RACSignal createSignal:^RACDisposable *(id&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">[self.signInService</span><br><span class="line">signInWithUsername:self.usernameTextField.text</span><br><span class="line">password:self.passwordTextField.text</span><br><span class="line">complete:^(BOOL success) &#123;</span><br><span class="line">[subscriber sendNext:@(success)];</span><br><span class="line">[subscriber sendCompleted];</span><br><span class="line">&#125;];</span><br><span class="line"><span class="built_in">return</span> nil;</span><br><span class="line">&#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The above method creates a signal that signs in with the current username and password. Now for a breakdown of its component parts.</p>
<p>The above code uses the createSignal: method on RACSignal for signal creation. The block that describes this signal is a single argument, and is passed to this method. When this signal has a subscriber, the code within this block executes.</p>
<p>The block is passed a single subscriber instance that adopts the RACSubscriber protocol, which has methods you invoke in order to emit events; you may also send any number of next events, terminated with either an error or complete event. In this case, it sends a single next event to indicate whether the sign-in was a success, followed by a complete event.</p>
<p>The return type for this block is an RACDisposable object, and it allows you to perform any clean-up work that might be required when a subscription is cancelled or trashed. This signal does not have any clean-up requirements, hence nil is returned.</p>
<p>As you can see, it’s surprisingly simple to wrap an asynchronous API in a signal!</p>
<p>Now to make use of this new signal. Update the code you added to the end of viewDidLoad in the previous section as follows:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[[[self.signInButton</span><br><span class="line">rac_signalForControlEvents:UIControlEventTouchUpInside]</span><br><span class="line">map:^id(id x) &#123;</span><br><span class="line"><span class="built_in">return</span> [self signInSignal];</span><br><span class="line">&#125;]</span><br><span class="line">subscribeNext:^(id x) &#123;</span><br><span class="line">NSLog(@<span class="string">&quot;Sign in result: %@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<p>The above code uses the map method used earlier to transform the button touch signal into the sign-in signal. The subscriber simply logs the result.</p>
<p>If you build and run, then tap the Sign In button, and take a look at the Xcode console, you’ll see the result of the above code …</p>
<p>… and the result isn’t quite what you might have expected!</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2014-01-08 21:00:25.919 RWReactivePlayground[33818:a0b] Sign <span class="keyword">in</span> result:</span><br><span class="line">&lt;RACDynamicSignal: 0xa068a00&gt; name: +createSignal:</span><br></pre></td></tr></table></figure>
<p>The subscribeNext: block has been passed a signal all right, but not the result of the sign-in signal!</p>
<p>Time to illustrate this pipeline so you can see what’s going on:</p>
<p>The rac_signalForControlEvents emits a next event (with the source UIButton as its event data) when you tap the button. The map step creates and returns the sign-in signal, which means the following pipeline steps now receive a RACSignal. That is what you’re observing at the subscribeNext: step.</p>
<p>The situation above is sometimes called the signal of signals; in other words an outer signal that contains an inner signal. If you really wanted to, you could subscribe to the inner signal within the outer signal’s subscribeNext: block. However it would result in a nested mess! Fortunately, it’s a common problem, and ReactiveCocoa is ready for this scenario.</p>
<p>Signal of Signals</p>
<p>The solution to this problem is straightforward, just change the map step to a flattenMap step as shown below:</p>
   <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">    [[[self.signInButton</span><br><span class="line">    rac_signalForControlEvents:UIControlEventTouchUpInside]</span><br><span class="line">    flattenMap:^id(id x) &#123;</span><br><span class="line">    <span class="built_in">return</span> [self signInSignal];</span><br><span class="line">    &#125;]</span><br><span class="line">    subscribeNext:^(id x) &#123;</span><br><span class="line">    NSLog(@<span class="string">&quot;Sign in result: %@&quot;</span>, x);</span><br><span class="line">    &#125;];```</span><br><span class="line"></span><br><span class="line">This maps the button touch event to a sign-in signal as before, but also flattens it by sending the events from the inner signal to the outer signal.</span><br><span class="line"></span><br><span class="line">Build and run, and keep an eye on the console. It should now <span class="built_in">log</span> whether the sign-in was successful or not:</span><br><span class="line">```bash</span><br><span class="line">2013-12-28 18:20:08.156 RWReactivePlayground[22993:a0b] Sign <span class="keyword">in</span> result: 0</span><br><span class="line">2013-12-28 18:25:50.927 RWReactivePlayground[22993:a0b] Sign <span class="keyword">in</span> result: 1</span><br></pre></td></tr></table></figure>
<p>Exciting stuff!</p>
<p>Now that the pipeline is doing what you want, the final step is to add the logic to the subscribeNext step to perform the required navigation upon successful sign-in. Replace the pipeline with the following:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[[[self.signInButton</span><br><span class="line">rac_signalForControlEvents:UIControlEventTouchUpInside]</span><br><span class="line">flattenMap:^id(id x) &#123;</span><br><span class="line"><span class="built_in">return</span> [self signInSignal];</span><br><span class="line">&#125;]</span><br><span class="line">subscribeNext:^(NSNumber *signedIn) &#123;</span><br><span class="line">BOOL success = [signedIn boolValue];</span><br><span class="line">self.signInFailureText.hidden = success;</span><br><span class="line"><span class="keyword">if</span> (success) &#123;</span><br><span class="line">[self performSegueWithIdentifier:@<span class="string">&quot;signInSuccess&quot;</span> sender:self];</span><br><span class="line">&#125;</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<p>The subscribeNext: block takes the result from the sign-in signal, updates the visibility of the signInFailureText text field accordingly, and performs the navigation segue if required.</p>
<p>Build and run to enjoy the kitten once more! Meow!</p>
<p>Did you notice there is one small user experience issue with the current application? When the sign-in service validates the supplied credentials, is should disable the Sign In button. This prevents the user from repeating the same sign-in. Furthermore, if a failed sign-in attempt occurred, the error message should be hidden when the user tries to sign-in once again.</p>
<p>But how should you add this logic to the current pipeline? Changing the button’s enabled state isn’t a transformation, filter or any of the other concepts you’ve encountered so far. Instead, it’s what is known as a side-effect; or logic you want to execute within a pipeline when a next event occurs, but it does not actually change the nature of the event itself.</p>
<p>Adding side-effects</p>
<p>Replace the current pipeline with the following:</p>
<pre><code class="bash">[[[[self.signInButton
rac_signalForControlEvents:UIControlEventTouchUpInside]
doNext:^(id x) &#123;
self.signInButton.enabled = NO;
self.signInFailureText.hidden = YES;
&#125;]
flattenMap:^id(id x) &#123;
return [self signInSignal];
&#125;]
subscribeNext:^(NSNumber *signedIn) &#123;
self.signInButton.enabled = YES;
BOOL success = [signedIn boolValue];
self.signInFailureText.hidden = success;
if (success) &#123;
[self performSegueWithIdentifier:@&quot;signInSuccess&quot; sender:self];
&#125;
&#125;];```

You can see how the above adds a doNext: step to the pipeline immediately after button touch event creation. Notice that the doNext: block does not return a value, because it’s a side-effect; it leaves the event itself unchanged.

The doNext: block above sets the button enabled property to NO, and hides the failure text. Whilst the subscribeNext: block re-enables the button, and either displays or hides the failure text based on the result of the sign-in.

It’s time to update the pipeline diagram to include this side effect. Bask in all it’s glory:



Build and run the application to confirm the Sign In button enables and disables as expected.

And with that, your work is done – the application is now fully reactive. Woot!

If you got lost along the way, you can download the final project (complete with dependencies), or you can obtain the code from GitHub, where there is a commit to match each build and run step in this tutorial.

Note: Disabling buttons while some asynchronous activity is underway is a common problem, and once again ReactiveCocoa is all over this little snafu. The RACCommand encapsulates this concept, and has an enabled signal that allows you to wire up the enabled property of a button to a signal. You might want to give the class a try.

Conclusions


Want to learn even faster? Save time with ourvideo courses
Hopefully this tutorial has given you a good foundation that will help you when starting to use ReactiveCocoa in your own applications. It can take a bit of practice to get used to the concepts, but like any language or program, once you get the hang of it it’s really quite simple. At the very core of ReactiveCocoa are signals, which are nothing more than streams of events. What could be simpler than that?

With ReactiveCocoa one of the interesting things I have found is there are numerous ways in which you can solve the same problem. You might want to experiment with this application, and adjust the signals and pipelines to change the way they split and combine.

It’s worth considering that the main goal of ReactiveCocoa is to make your code cleaner and easier to understand. Personally I find it easier to understand what an application does if its logic is represented as clear pipelines, using the fluent syntax.




​
</code></pre>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/09/11/00-MyFirstBlog/" rel="next" title="My first Blog">
                <i class="fa fa-chevron-left"></i> My first Blog
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/07/12/02-%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9AObject-C%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%9C%AC%E8%B4%A8/" rel="prev" title="底层原理（一）：Object-C对象的本质">
                底层原理（一）：Object-C对象的本质 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <p class="site-author-name" itemprop="name"></p>
            <p class="site-description motion-element" itemprop="description"></p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/%7C%7C%20archive%20%20%20/%E5%BD%92%E6%A1%A3">
            
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yangyuanwei</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" rel="noopener" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" rel="noopener" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.2</div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
